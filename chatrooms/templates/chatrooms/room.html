{% extends "base/base.html" %}
{% load static customtags %}
{% load static %}

{% block title %}Chat{% endblock %}
{% block head %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
<link href='https://unpkg.com/boxicons@2.0.9/css/boxicons.min.css' rel='stylesheet'>
<link href="{% static 'css/navbar_and_chatlist.css' %}" rel="stylesheet">
<link href="{% static 'css/room.css' %}" rel="stylesheet">

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
{% endblock %}

{% block content %}
<div class="chat-zone text-left">
    <div class="chat-nav">
        <nav class="navbar navbar-expand-lg navbar-light bg-light">
            <div class="container-fluid">
                <div class="navbar-brand" href="">
                    {% if receiver.avatar == "" %}
                        <img src="{% static 'images/profile.png' %}" class="rounded-circle home_button">        
                    {% else %}
                        <img src="{{receiver.avatar}}" class="rounded-circle home_button">        
                    {% endif %}
                </div>
        
                <div class="receiver-fullname"> {{receiver.first_name}} {{receiver.last_name}} </div>
                
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                    data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false"
                    aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarSupportedContent">
                    <ul class="navbar-nav mx-auto mb-2 mb-lg-0">
                        <button class="nav-item btn" type="button" data-bs-toggle="offcanvas"
                            data-bs-target="#offcanvasRight" aria-controls="offcanvasRight">
                            <i class='nav-link bx bxl-messenger icon'></i>
                        </button>
                        <button class="nav-item btn" type="button">
                            <a role="button" href="/chat/{{receiver.username}}/receiverprofile">
                                <i class='nav-link bx bxs-user-account icon'></i>
                            </a>
                        </button>
                    </ul>
                    <ul class="navbar-nav me-0 mb-2 mb-lg-0">
                        <button class="nav-item btn" type="button">
                            <a role="button" href="/chat">
                                <i class='nav-link bx bx-log-out icon'></i>
                            </a>
                        </button>
                    </ul>
                </div>
            </div>
        </nav>
        
        <div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasRight" aria-labelledby="offcanvasRightLabel">
            <div class="offcanvas-header">
                <h1 id="offcanvasRightLabel"> <strong>Your Friends</strong></h1>
                <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
            </div>
        
            <div class="offcanvas-body">
                <form class="d-flex" action="">
                    <input id='search' class="form-control me-2" type="search" placeholder="Search" aria-label="Search"
                        name="search">
                    <button class="btn btn-outline-success" type="button">
                        <i class='bx bx-search-alt'></i>
                    </button>
                </form>
        
                <div class="chat-list" id='friend'>
                    {% for user_dict in users %}
                    <div class="friend">
                        <a class="btn left-side" href="{% build_chat_url user.username user_dict.username %}">
                            {{user_dict.first_name}} {{user_dict.last_name}}
                        <a class="btn right-side" href="/chat/{{user_dict.username}}/receiverprofile">
                            <i class='bx bxs-user-account icon receiver'></i>
                        </a>
                    </div>
        
                    {% empty %}
                    <p class="text-muted">Ups! no users to chat with.</p>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <div class="chat-right">
        <div class="chat-box" >
            <div id="chat-messages" class="card card-body card-chat text-left"> </div>
        </div>
        <div class="mess-line">
            <div class="mess-form">
                <input id="message" class="form-control" type="text" placeholder="Type your message...">
            </div>
            <div class="mess-send">
                <a id="send-message" class="btn float-right">
                    <i class='bx bx-send icon' ></i>
                </a>
            </div>
        </div>
    </div>
    
</div>


<script src="{% static 'reconnecting-websocket.js' %}"></script>
<script type="text/javascript">
    $('#chat-messages').stop().animate({
        scrollTop: $('#chat-messages')[0].scrollHeight
        }, "fast"
    );

    $(document).ready(function() {
        $("#send-message").click(function() {
            $('#chat-messages').stop().animate({
                scrollTop: $('#chat-messages')[0].scrollHeight
                }, "fast"
            );
        });
    });

    $(function () {
        // function updateScroll(){
        //     var last_msg=document.querySelector('#chat-messages');
        //     last_msg.lastChild.scrollIntoView();
        // }

        function addMessageToChat(data) {
            $("#chat-messages").append("<b>" + data['username'] + ":</b> <p>" + data['message'] + "</p><br>");
        };
        $.getJSON("{% url 'messages' request.resolver_match.kwargs.room_name %}", function(data) {
            // Add each previous message to the chat.
            $.each(data, function(index, value) {
               addMessageToChat(value);
            });
            

        });
        websocket = new ReconnectingWebSocket(
            'ws://' + window.location.host +
            '/ws/chat/{{ request.resolver_match.kwargs.room_name }}/');

        websocket.onmessage = function (e) {
            var data = JSON.parse(e.data);
            addMessageToChat(data);
            console,localStorage(data);
        };

        websocket.onclose = function (e) {
            alert('There was a problem. Please refresh the page.');
        };
        $("#message").keyup(function(e){
            if(e.keyCode == 13)
            {
                $("#send-message").click();
            }
        });
        
        $("#send-message").click(function () {
            // Prevent user sending empty messages.
            if ($("#message").val() === "") { return };
            // Send message through the websocket.
            websocket.send(JSON.stringify({
                "username": "{{ user.username }}",
                "message": $("#message").val()
            }));
            // Clear the message input.
            $("#message").val("");
        });
    });
</script>

{% endblock %}